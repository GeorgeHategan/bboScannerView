<!DOCTYPE html>
<html>
<head>
    <title>VIX & VX30 History</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h1 { 
            margin: 0;
            color: #333;
        }
        .nav-links {
            display: flex;
            gap: 10px;
        }
        .nav-links a {
            background: #e8f4f8;
            color: #2c5f7a;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            border: 1px solid #d0e5ed;
        }
        .nav-links a:hover {
            background: #d0e5ed;
        }
        .nav-links a.download {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .nav-links a.download:hover {
            background: #c3e6cb;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            text-align: center;
        }
        .stat-box h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        .stat-box .value {
            font-size: 32px;
            font-weight: bold;
        }
        .stat-box .vix { color: #2ecc71; }
        .stat-box .vx30 { color: #3498db; }
        .stat-box .spread { color: #9b59b6; }
        .stat-box .timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .data-table {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        .table-scroll-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .table-scroll-container table {
            margin-bottom: 0;
        }
        .table-scroll-container thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 1;
        }
        .record-count {
            color: #666;
            font-size: 0.9em;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä VIX & VX30 History</h1>
        <div class="nav-links">
            <a href="/vix-chart/download" class="download">‚¨áÔ∏è Download CSV</a>
            <a href="/focus-list">üéØ Focus List</a>
            <a href="/">üîç Scanners</a>
            <a href="/options-signals">üìà Options Flows</a>
            <a href="/darkpool-signals">üåë Dark Pools</a>
            <a href="/sector-rotation">üîÑ Sector Rotation</a>
        </div>
    </div>

    {% if latest %}
    <div class="stats-container">
        <div class="stat-box">
            <h3>VIX Spot</h3>
            <div class="value vix">{{ "%.2f"|format(latest.vix) if latest.vix else 'N/A' }}</div>
            <div class="timestamp">Latest reading</div>
        </div>
        <div class="stat-box">
            <h3>VX30 (30-day)</h3>
            <div class="value vx30">{{ "%.2f"|format(latest.vx30) if latest.vx30 else 'N/A' }}</div>
            <div class="timestamp">Latest reading</div>
        </div>
        <div class="stat-box">
            <h3>Contango/Backwardation</h3>
            {% if latest.vix and latest.vx30 %}
                {% set spread = ((latest.vx30 - latest.vix) / latest.vix * 100) %}
                <div class="value spread">{{ "%+.2f"|format(spread) }}%</div>
                <div class="timestamp">
                    {% if spread > 0 %}Contango{% else %}Backwardation{% endif %}
                </div>
            {% else %}
                <div class="value spread">N/A</div>
            {% endif %}
        </div>
        <div class="stat-box">
            <h3>Last Updated</h3>
            <div class="value" style="font-size: 18px; color: #666;">{{ latest.timestamp }}</div>
            <div class="timestamp">Source: {{ latest.source }}</div>
        </div>
    </div>
    {% endif %}

    <div class="chart-container">
        <div id="vixChart" style="width: 100%; height: 500px;"></div>
    </div>

    <div class="data-table">
        <h3>VIX/VX30 Data <span class="record-count">({{ total_count }} total records)</span></h3>
        <div class="table-scroll-container">
        <table>
            <thead>
            <tr>
                <th>Timestamp (CET)</th>
                <th>VIX</th>
                <th>VX30</th>
                <th>Spread</th>
                <th>Source</th>
            </tr>
            </thead>
            <tbody>
            {% for row in history %}
            <tr>
                <td class="utc-time" data-utc="{{ row.timestamp }}">{{ row.timestamp }}</td>
                <td>{{ "%.2f"|format(row.vix) if row.vix else 'N/A' }}</td>
                <td>{{ "%.2f"|format(row.vx30) if row.vx30 else 'N/A' }}</td>
                <td>
                    {% if row.vix and row.vx30 %}
                        {% set spread = ((row.vx30 - row.vix) / row.vix * 100) %}
                        <span class="{{ 'positive' if spread > 0 else 'negative' }}">{{ "%+.2f"|format(spread) }}%</span>
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>{{ row.source }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        </div>
    </div>

    <script>
        // Convert UTC timestamps to CET (Central European Time)
        function convertToCET(utcString) {
            // Normalize the timestamp - replace space with T if needed
            let normalized = utcString.replace(' ', 'T');
            // Add Z if no timezone indicator present
            if (!normalized.includes('Z') && !normalized.includes('+') && !normalized.includes('-', 10)) {
                normalized += 'Z';
            }
            const date = new Date(normalized);
            if (isNaN(date.getTime())) {
                return utcString; // Return original if parsing fails
            }
            return date.toLocaleString('sv-SE', { 
                timeZone: 'CET',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // Convert all table timestamps
        document.querySelectorAll('.utc-time').forEach(function(el) {
            const utc = el.getAttribute('data-utc');
            if (utc) {
                el.textContent = convertToCET(utc);
            }
        });
        
        // Prepare data for Plotly
        var timestamps = {{ timestamps | tojson }};
        var vixValues = {{ vix_values | tojson }};
        var vx30Values = {{ vx30_values | tojson }};
        
        // Convert timestamps for chart
        timestamps = timestamps.map(function(ts) {
            return convertToCET(ts);
        });

        var trace1 = {
            x: timestamps,
            y: vixValues,
            name: 'VIX Spot',
            type: 'scatter',
            mode: 'lines',
            line: { color: '#2ecc71', width: 2 }
        };

        var trace2 = {
            x: timestamps,
            y: vx30Values,
            name: 'VX30',
            type: 'scatter',
            mode: 'lines',
            line: { color: '#3498db', width: 2 }
        };

        var layout = {
            title: 'VIX Spot vs VX30 History',
            xaxis: { 
                title: 'Time',
                type: 'date'
            },
            yaxis: { 
                title: 'Value',
                rangemode: 'tozero'
            },
            legend: {
                x: 0,
                y: 1.1,
                orientation: 'h'
            },
            hovermode: 'x unified',
            margin: { t: 50, r: 50, b: 50, l: 50 }
        };

        var config = {
            responsive: true,
            displayModeBar: true
        };

        Plotly.newPlot('vixChart', [trace1, trace2], layout, config);
    </script>
</body>
</html>